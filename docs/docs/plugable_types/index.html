<!DOCTYPE html>
<html lang="en-us">
  <head>
    

<meta property="og:title" content="Plugable Types" />
<meta property="og:description" content="Description Rekor supports pluggable types (aka different schemas) for entries stored in the transparency log. This will allow you to develop your own manifest type in your prefered formatting style (json|yaml|xml).
Currently supported types  Rekord (default type) schema  Versions: 0.0.1    Base Schema The base schema for all types is modeled off of the schema used by Kubernetes and can be found in openapi.yaml as #/definitions/ProposedEntry:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/plugable_types/" />
<meta property="article:published_time" content="2020-12-11T12:07:22+00:00" />
<meta property="article:modified_time" content="2020-12-11T12:07:22+00:00" />


<meta name="description" content="Hardcoded description; the author should update :)" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>sigstore</title>
    
<link rel="icon" type="image/png" href="/images/favicon.png" />
<link href="https://fonts.googleapis.com/css?family=Catamaran:400,600" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/style.min.f8746099fa9580878ac8821d7955609e754fcc0e51b89057b1b14a3787c4a353.css" integrity="sha256-&#43;HRgmfqVgIeKyIIdeVVgnnVPzA5RuJBXsbFKN4fEo1M=">
<link rel="stylesheet" type="text/css" href="/css/icons.css">

  </head>
  <body>
    
    <div id="preloader">
      <div id="status"></div>
    </div>

    

    

<nav class="navbar is-fresh is-transparent no-shadow" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="/images/logos/rekor-logo.png" alt="" width="112" height="28">
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbar-menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

      <div id="navbar-menu" class="navbar-menu is-static">

        <div class="navbar-end">
          <a href="https://github.com/SigStore" class="navbar-item is-secondary">
            Community
          </a>
          <a href="/what_is_sigstore/" class="navbar-item is-secondary">
            Learn More
          </a>
        </div>
      </div>
  </div>
</nav>



<nav id="navbar-clone" class="navbar is-fresh is-transparent" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="/images/logos/rekor-logo.png" alt="" width="112" height="28">
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="cloned-navbar-menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="cloned-navbar-menu" class="navbar-menu is-fixed">

      <div class="navbar-end">
        <a href="https://github.com/SigStore" class="navbar-item is-secondary">
          Community
        </a>
        <a href="/what_is_sigstore/" class="navbar-item is-secondary">
          Learn More
        </a>
      </div>
    </div>
</div>
</nav>

<section class="section is-medium">
  <div class="container">
    <div class="columns">
      <div class="column is-centered-tablet-portrait">
        <h1 class="title section-title">Plugable Types</h1>
        <h5 class="subtitle is-5 is-muted"></h5>
        <div class="divider"></div>
      </div>
    </div>

    <div class="content">
      <h2 id="description">Description</h2>
<p>Rekor supports pluggable types (aka different schemas) for entries stored in the transparency log. This will allow you to develop
your own manifest type in your prefered formatting style (json|yaml|xml).</p>
<h3 id="currently-supported-types">Currently supported types</h3>
<ul>
<li>Rekord (default type) <a href="rekord/rekord_schema.md">schema</a>
<ul>
<li>Versions: 0.0.1</li>
</ul>
</li>
</ul>
<h2 id="base-schema">Base Schema</h2>
<p>The base schema for all types is modeled off of the schema used by Kubernetes and can be found in <code>openapi.yaml</code> as <code>#/definitions/ProposedEntry</code>:</p>
<pre><code>definitions:
  ProposedEntry:
    type: object
    discriminator: kind
    properties:
      kind:
        type: string
    required:
      - kind
</code></pre><p>The <code>kind</code> property is a <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#fixed-fields-13">discriminator</a> that is used to differentiate between different pluggable types. Types can have one or more versions of the schema supported concurrently by the same Rekor instance; an example implementation can be seen in <code>rekord.go</code>.</p>
<h2 id="adding-support-for-a-new-type">Adding Support for a New Type</h2>
<p>To add a new type (called <code>newType</code> in this example):</p>
<ol>
<li>Add a new definition in <code>openapi.yaml</code> that is a derived type of ProposedEntry (expressed in the <code>allOf</code> list seen below); for example:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">newType</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">newType object</span><span class="w">
</span><span class="w">  </span><span class="nt">allOf</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;#/definitions/ProposedEntry&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span><span class="w">          </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span><span class="w">          </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pkg/types/newType/newType_schema.json&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">required</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">version</span><span class="w">
</span><span class="w">        </span>- <span class="l">data</span><span class="w">
</span><span class="w">      </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></code></pre></div><blockquote>
<p>Note: the <code>$ref</code> feature can be used to refer to an externally defined JSON schema document; however it is also permitted to describe the entirety of the type in valid Swagger (aka OpenAPI) v2 format within <code>openapi.yaml</code>.</p>
</blockquote>
<ol start="2">
<li>
<p>Create a subdirectory under <code>pkg/types/</code> with your type name (e.g. <code>newType</code>) as a new Go package</p>
</li>
<li>
<p>In this new Go package, define a struct that implements the <code>TypeImpl</code> interface as defined in <code>types.go</code>:</p>
</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">TypeImpl</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Kind</span><span class="p">()</span> <span class="kt">string</span>
	<span class="nf">UnmarshalEntry</span><span class="p">(</span><span class="nx">pe</span> <span class="nx">models</span><span class="p">.</span><span class="nx">ProposedEntry</span><span class="p">)</span> <span class="p">(</span><span class="nx">EntryImpl</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><ul>
<li><code>Kind</code> must return the <em>exact</em> same string as you named your new type in <code>openapi.yaml</code> (e.g. &ldquo;<code>newType</code>&quot;)</li>
<li><code>UnmarshalEntry</code> will be called with a pointer to a struct that was automatically generated for the type defined in <code>openapi.yaml</code> by the <a href="http://github.com/go-swagger/go-swagger">go-swagger</a> tool used by Rekor
<ul>
<li>This struct will be defined in the generated file at <code>pkg/generated/models/newType.go</code> (where <code>newType</code> is replaced with the name of the type you are adding)</li>
<li>This method should return a pointer to an instance of a struct that implements the <code>EntryImpl</code> interface as defined in <code>types.go</code>, or a <code>nil</code> pointer with an error specified</li>
</ul>
</li>
</ul>
<ol start="4">
<li>Also in this Go package, provide an implementation of the <code>EntryImpl</code> interface as defined in <code>types.go</code>:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">EntryImpl</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">APIVersion</span><span class="p">()</span> <span class="kt">string</span>
	<span class="nf">Canonicalize</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">FetchExternalEntities</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span>
	<span class="nf">HasExternalEntities</span><span class="p">()</span> <span class="kt">bool</span>
	<span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">pe</span> <span class="nx">models</span><span class="p">.</span><span class="nx">ProposedEntry</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></div><ul>
<li><code>APIVersion</code> should return a version string that identifies the version of the type supported by the Rekor server</li>
<li><code>Canonicalize</code> should return a <code>[]byte</code> containing the canonicalized contents representing the entry. The canonicalization of contents is important as we should have one record per unique signed object in the transparency log.</li>
<li><code>FetchExternalEntities</code> should retrieve any entities that make up the entry which were not included in the object provided in the HTTP request to the Rekor server</li>
<li><code>HasExternalEntities</code> indicates whether the instance of the struct has any external entities it has yet to fetch and resolve</li>
<li><code>Unmarshal</code> will be called with a pointer to a struct that was automatically generated for the type defined in <code>openapi.yaml</code> by the <a href="http://github.com/go-swagger/go-swagger">go-swagger</a> tool used by Rekor
<ul>
<li>This method should validate the contents of the struct to ensure any string or cross-field dependencies are met to successfully insert an entry of this type into the transparency log</li>
</ul>
</li>
</ul>
<ol start="5">
<li>In the Go package you have created for the new type, be sure to add an entry in the <code>TypeMap</code> in <code>github.com/projectrekor/rekor/pkg/types</code> for your new type in the <code>init</code> method for your package. The key for the map is the unique string used to define your type in <code>openapi.yaml</code> (e.g. <code>newType</code>), and the value for the map is the name of a factory function for an instance of <code>TypeImpl</code>.</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">types</span><span class="p">.</span><span class="nx">TypeMap</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;newType&#34;</span><span class="p">,</span> <span class="nx">NewEntry</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><ol start="6">
<li>
<p>Add an entry to <code>pluggableTypeMap</code> in <code>cmd/server/app/serve.go</code> that provides a reference to your package. This ensures that the <code>init</code> function of your type (and optionally, your version implementation) will be called before the server starts to process incoming requests and therefore will be added to the map that is used to route request processing for different types.</p>
</li>
<li>
<p>After adding sufficient unit &amp; integration tests, submit a pull request to <code>projectrekor/rekor</code> for review and addition to the codebase.</p>
</li>
</ol>
<h2 id="adding-a-new-version-of-the-rekord-type">Adding a New Version of the <code>Rekord</code> type</h2>
<p>To add new version of the default <code>Rekord</code> type:</p>
<ol>
<li>
<p>Create a new subdirectory under <code>pkg/types/rekord/</code> for the new version</p>
</li>
<li>
<p>If there are changes to the Rekord schema for this version, create a new JSON schema document and add a reference to it within the <code>oneOf</code> clause in <code>rekord_schema.json</code>. If there are no changes, skip this step.</p>
</li>
<li>
<p>Provide an implementation of the <code>EntryImpl</code> interface as defined in <code>pkg/types/types.go</code> for the new version.</p>
</li>
<li>
<p>In your package&rsquo;s <code>init</code> method, ensure there is a call to <code>SemVerToFacFnMap.Set()</code> which provides the link between the valid <em>semver</em> ranges that your package can successfully process and the factory function that creates an instance of a struct for your new version.</p>
</li>
<li>
<p>Add an entry to <code>pluggableTypeMap</code> in <code>cmd/server/app/serve.go</code> that provides a reference to the Go package implementing the new version. This ensures that the <code>init</code> function will be called before the server starts to process incoming requests and therefore will be added to the map that is used to route request processing for different types.</p>
</li>
<li>
<p>After adding sufficient unit &amp; integration tests, submit a pull request to <code>projectrekor/rekor</code> for review and addition to the codebase.</p>
</li>
</ol>

    </div>
  </div>
</section>



    

    
    <div id="backtotop"><a href="#"></a></div>

    

    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="/js/fresh.js"></script>
<script src="/js/jquery.panelslider.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  </body>
</html>
